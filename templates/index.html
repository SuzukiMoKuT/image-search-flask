<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ç”»åƒæ¤œç´¢</title>
    <title>Image Analysis</title>

    <style>
    :root{
        --bg:#0b1020;
        --card:#111a33;
        --card2:#0f1730;
        --text:#e8ecff;
        --muted:#a8b0d6;
        --line:#23305a;
        --accent:#7aa2ff;
        --accent2:#6ee7ff;
        --danger:#ff6b6b;
        --shadow: 0 18px 50px rgba(0,0,0,.35);
        --radius: 18px;
        --radius2: 14px;
        --pad: 18px;
    }
    [data-theme="light"]{
        --bg:#f6f7ff;
        --card:#ffffff;
        --card2:#ffffff;
        --text:#121528;
        --muted:#5a648a;
        --line:#e4e7ff;
        --accent:#375bff;
        --accent2:#00a5c7;
        --danger:#d64545;
        --shadow: 0 18px 50px rgba(16,21,40,.12);
    }

    *{ box-sizing:border-box; }
    body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif;
        background: radial-gradient(1200px 900px at 20% 0%, rgba(122,162,255,.18), transparent 55%),
                    radial-gradient(1000px 700px at 90% 10%, rgba(110,231,255,.14), transparent 60%),
                    var(--bg);
        color:var(--text);
    }
    a{ color:inherit; }
    .wrap{ max-width:1100px; margin:0 auto; padding: 26px 16px 60px; }

    /* Header */
    .topbar{
        display:flex; align-items:center; justify-content:space-between;
        gap:12px; margin-bottom: 18px;
    }
    .brand{
        display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{
        margin:0; font-size: 22px; letter-spacing:.2px;
    }
    .brand p{
        margin:0; color:var(--muted); font-size: 13px;
    }
    .actions{ display:flex; gap:10px; align-items:center; }
    .btn{
        border:1px solid var(--line);
        background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
        color:var(--text);
        padding:10px 12px;
        border-radius: 12px;
        cursor:pointer;
        transition: .15s;
        box-shadow: 0 10px 24px rgba(0,0,0,.14);
        display:inline-flex; align-items:center; gap:8px;
        user-select:none;
    }
    [data-theme="light"] .btn{ box-shadow: 0 10px 24px rgba(16,21,40,.10); }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(122,162,255,.5); }
    .btn:active{ transform: translateY(0px); }

    /* Layout */
    .grid{
        display:grid;
        grid-template-columns: 380px 1fr;
        gap: 16px;
        align-items:start;
    }
    @media (max-width: 980px){
        .grid{ grid-template-columns: 1fr; }
    }

    .card{
        background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
        border:1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow:hidden;
    }
    .card .hd{
        padding: 16px 18px;
        background: rgba(0,0,0,.10);
        border-bottom:1px solid var(--line);
        display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    [data-theme="light"] .card .hd{ background: rgba(55,91,255,.05); }
    .card .hd .title{
        display:flex; flex-direction:column; gap:4px;
    }
    .card .hd .title b{ font-size:14px; }
    .card .hd .title span{ font-size:12px; color:var(--muted); }
    .card .bd{ padding: 16px 18px; }

    .error{
        padding: 10px 12px;
        border-radius: 12px;
        background: rgba(255,107,107,.14);
        border:1px solid rgba(255,107,107,.35);
        color: var(--text);
        margin-bottom: 12px;
        font-size: 13px;
    }

    /* Form */
    label{ font-size: 13px; color: var(--muted); display:block; margin-bottom:8px; }
    .field{ margin-bottom: 14px; }
    input[type="file"]{
        width:100%;
        padding: 12px;
        border-radius: 14px;
        border:1px solid var(--line);
        background: rgba(0,0,0,.12);
        color: var(--text);
    }
    [data-theme="light"] input[type="file"]{ background: rgba(16,21,40,.03); }

    .row{
        display:flex; gap:10px; align-items:center;
    }
    .row > *{ flex:1; }

    .slider{
        display:flex; align-items:center; gap:10px;
        padding: 10px 12px;
        border:1px solid var(--line);
        border-radius: 14px;
        background: rgba(0,0,0,.12);
    }
    [data-theme="light"] .slider{ background: rgba(16,21,40,.03); }
    input[type="range"]{ width:100%; }
    input[type="number"]{
        width: 90px;
        padding: 10px 10px;
        border-radius: 12px;
        border:1px solid var(--line);
        background: rgba(0,0,0,.10);
        color: var(--text);
    }
    [data-theme="light"] input[type="number"]{ background: rgba(16,21,40,.02); }

    .hint{
        margin-top: 8px; font-size: 12px; color: var(--muted);
        display:flex; justify-content:space-between;
    }
    .pillbar{ display:flex; gap:8px; margin-top: 10px; flex-wrap:wrap; }
    .pill{
        padding: 8px 10px;
        border:1px solid var(--line);
        border-radius: 999px;
        font-size: 12px;
        color: var(--muted);
        background: rgba(0,0,0,.10);
        cursor:pointer;
        transition:.15s;
    }
    [data-theme="light"] .pill{ background: rgba(16,21,40,.02); }
    .pill:hover{ border-color: rgba(122,162,255,.45); color: var(--text); }

    .primary{
        width:100%;
        margin-top: 12px;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1px solid rgba(122,162,255,.65);
        background: linear-gradient(135deg, rgba(122,162,255,.95), rgba(110,231,255,.75));
        color: #08102b;
        font-weight: 800;
        cursor:pointer;
        transition:.15s;
    }
    .primary:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .primary:active{ transform: translateY(0); }

    /* Results */
    .subgrid{
        display:flex; flex-direction:column; gap: 16px;
    }
    .baseBox{
        display:flex; gap: 12px; align-items:center;
    }
    .baseBox img{
        width: 120px; height: 120px; object-fit: cover;
        border-radius: 16px;
        border:1px solid var(--line);
        background: rgba(0,0,0,.10);
    }
    .baseMeta{ display:flex; flex-direction:column; gap:6px; }
    .baseMeta b{ font-size:14px; }
    .baseMeta span{ font-size:12px; color: var(--muted); }

    .resultsGrid{
        display:grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
    }
    @media (max-width: 980px){ .resultsGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 560px){ .resultsGrid{ grid-template-columns: 1fr; } }

    .item{
        border:1px solid var(--line);
        border-radius: var(--radius2);
        background: rgba(0,0,0,.10);
        overflow:hidden;
        cursor:pointer;
        transition:.15s;
        display:flex; flex-direction:column;
        min-height: 250px;
    }
    [data-theme="light"] .item{ background: rgba(16,21,40,.02); }
    .item:hover{ transform: translateY(-2px); border-color: rgba(122,162,255,.45); }
    .thumb{
        aspect-ratio: 4 / 3;
        width:100%;
        object-fit: cover;
        background: rgba(0,0,0,.08);
    }
    .meta{ padding: 12px 12px 14px; display:flex; flex-direction:column; gap:10px; }
    .scoreLine{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .scoreLine b{ font-size:13px; }
    .scoreLine span{ font-size:12px; color: var(--muted); }

    .bar{
        height: 10px;
        border-radius: 999px;
        background: rgba(255,255,255,.08);
        border:1px solid var(--line);
        overflow:hidden;
    }
    .bar > div{
        height:100%;
        width:0%;
        background: linear-gradient(90deg, rgba(110,231,255,.9), rgba(122,162,255,.95));
    }
    .desc{
        font-size: 12px;
        color: var(--muted);
        line-height: 1.45;
        min-height: 34px;
    }

    .empty{
        padding: 18px;
        border-radius: var(--radius);
        border:1px dashed var(--line);
        color: var(--muted);
        background: rgba(0,0,0,.08);
    }
    [data-theme="light"] .empty{ background: rgba(16,21,40,.02); }

    /* Popup */
    #popup{
        display:none;
        position:fixed;
        inset:0;
        background: rgba(0,0,0,.75);
        z-index: 9999;
        align-items:center;
        justify-content:center;
        padding: 20px;
    }
    .modal{
        width:min(980px, 100%);
        border-radius: 20px;
        border:1px solid rgba(255,255,255,.12);
        background: var(--card);
        box-shadow: 0 30px 90px rgba(0,0,0,.55);
        overflow:hidden;
    }
    [data-theme="light"] .modal{
        border-color: var(--line);
        box-shadow: 0 30px 90px rgba(16,21,40,.25);
    }
    .modalHd{
        padding: 12px 14px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        border-bottom:1px solid var(--line);
        background: rgba(0,0,0,.10);
    }
    [data-theme="light"] .modalHd{ background: rgba(55,91,255,.05); }
    .modalHd b{ font-size: 13px; }
    .x{
        border:1px solid var(--line);
        background: rgba(255,255,255,.06);
        color: var(--text);
        width: 36px; height: 36px;
        border-radius: 12px;
        cursor:pointer;
        display:grid; place-items:center;
        transition:.15s;
    }
    .x:hover{ transform: translateY(-1px); border-color: rgba(122,162,255,.45); }
    .modalBd{
        display:grid;
        grid-template-columns: 1fr 360px;
        gap: 0;
        min-height: 520px;
    }
    @media (max-width: 900px){
        .modalBd{ grid-template-columns: 1fr; }
    }
    .modalImg{
        background: rgba(0,0,0,.10);
        display:flex; align-items:center; justify-content:center;
        padding: 14px;
        border-right:1px solid var(--line);
    }
    @media (max-width: 900px){
        .modalImg{ border-right:none; border-bottom:1px solid var(--line); }
    }
    .modalImg img{
        max-width:100%;
        max-height: 520px;
        border-radius: 16px;
        border:1px solid var(--line);
        background: rgba(0,0,0,.08);
    }
    .modalSide{
        padding: 14px 14px 18px;
        display:flex;
        flex-direction:column;
        gap: 12px;
    }
    .kv{
        display:flex; flex-direction:column; gap:6px;
        padding: 12px;
        border-radius: 16px;
        border:1px solid var(--line);
        background: rgba(0,0,0,.08);
    }
    [data-theme="light"] .kv{ background: rgba(16,21,40,.02); }
    .kv b{ font-size: 13px; }
    .kv span{ font-size: 12px; color: var(--muted); line-height: 1.5; }
    .loading{
        display:inline-flex; gap:8px; align-items:center; color: var(--muted);
        font-size: 12px;
    }
    .dot{ width:6px; height:6px; border-radius:99px; background: var(--muted); animation: blink 1s infinite; }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .3s; }
    @keyframes blink{ 0%, 100%{ opacity:.2 } 50%{ opacity:1 } }
  </style>
</head>

<body>
<div class="wrap">

    <div class="topbar">
        <div class="brand">
            <h1>ç”»åƒæ¤œç´¢ã‚¢ãƒ—ãƒª</h1>
            <h3>Image Search App</h3>
            <p>é¡ä¼¼åº¦ã—ãã„å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ã€ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º</p>
            <p>Filter by similarity threshold, click to display popup</p>
        </div>
        <div class="actions">
            <button class="btn" type="button" onclick="toggleTheme()">
                <span>ğŸŒ“</span><span id="themeLabel">Theme</span>
            </button>
        </div>
    </div>

    <div class="grid">

        <!-- Left: Form -->
        <div class="card">
            <div class="hd">
                <div class="title">
                    <b>æ¤œç´¢è¨­å®š</b>
                    <b>Search Settings</b>
                    <span>åŸºæº–ç”»åƒã¨æ¤œç´¢ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã¶</span>
                    <span>Select the reference image and search folder</span>
                </div>
            </div>
            <div class="bd">
                {% if error %}
                <div class="error">âš ï¸ {{ error }}</div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" id="searchForm">
                    <input type="hidden" name="prev_base" value="{{ base }}">

                    <div class="field">
                        <label>åŸºæº–ç”»åƒï¼ˆæœªé¸æŠãªã‚‰å‰å›ã®ã¾ã¾ï¼‰</label>
                        <label>Reference image (if not selected, defaults to the previous one)</label>
                        <input type="file" name="base" accept="image/*">
                    </div>

                    <div class="field">
                        <label>æ¤œç´¢ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆè¤‡æ•°é¸æŠï¼‰</label>
                        <label>Search folder (multiple selection allowed)</label>
                        <input type="file" name="folder" accept="image/*" multiple required>
                    </div>

                    <div class="field">
                        <label>ğŸ¯ é¡ä¼¼åº¦ã—ãã„å€¤</label>
                        <label>Similarity Threshold</label>
                        <div class="slider">
                            <input type="range"
                                name="threshold"
                                min="0" max="1" step="0.01"
                                value="{{ threshold | default(0.4) }}"
                                oninput="syncThreshold(this.value)">
                            <input type="number"
                                id="thNum"
                                min="0" max="1" step="0.01"
                                value="{{ threshold | default(0.4) }}"
                                oninput="syncThreshold(this.value, true)">
                        </div>
                        <div class="hint">
                            <span>ã‚†ã‚‹ã‚ï¼ˆçµæœå¤šã‚ï¼‰Looser</span>
                            <span>å³ã—ã‚ï¼ˆé«˜ç²¾åº¦ï¼‰Stricter</span>
                        </div>

                        <div class="pillbar">
                            <div class="pill" onclick="bumpThreshold(-0.05)">âˆ’0.05</div>
                            <div class="pill" onclick="bumpThreshold(-0.10)">âˆ’0.10</div>
                            <div class="pill" onclick="bumpThreshold(+0.05)">ï¼‹0.05</div>
                            <div class="pill" onclick="bumpThreshold(+0.10)">ï¼‹0.10</div>
                            <div class="pill" onclick="setThreshold(0.40)">ãŠã™ã™ã‚(Recomended): 0.40</div>
                            <div class="pill" onclick="setThreshold(0.70)">ãŠã™ã™ã‚(Recomended): 0.70</div>
                        </div>
                    </div>

                    <button class="primary" type="submit">æ¤œç´¢é–‹å§‹<br>Start Search</button>
                </form>
            </div>
        </div>

        <!-- Right: Results -->
        <div class="subgrid">

            <div class="card">
                <div class="hd">
                    <div class="title">
                        <b>æ¤œç´¢çµæœ<br>Results</b>
                        <span>ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§ + èª¬æ˜</span>
                    </div>
                </div>
                <div class="bd">

                    <div id="resultsArea">
                        {% if base %}
                        <div class="baseBox">
                            <img src="/static/uploads/{{ base }}" alt="base">
                            <div class="baseMeta">
                                <b>åŸºæº–ç”»åƒ (Reference image)</b>
                                <span>åŸºæº–ç”»åƒã¯ä¿æŒã•ã‚Œã¾ã™ï¼ˆå†é¸æŠã—ãªãã¦OKï¼‰</span>
                                <span>The reference image will be retained (no need to reselect it)</span>
                                <span>ã—ãã„å€¤ (Threshold): {{ "%.2f"|format(threshold | default(0.4)) }}</span>
                            </div>
                        </div>
                        <div style="height:14px"></div>
                            {% endif %}

                            {% if results %}
                            <div class="resultsGrid">
                                {% for r in results %}
                                    {% set name = r[0] %}
                                    {% set score = r[1] %}
                                    {% set desc = (r[2] if (r|length > 2) else "") %}
                                    {% set bar = ((score + 1) / 2 if score < 0 else score) %}
                                    {% if bar < 0 %}{% set bar = 0 %}{% endif %}
                                    {% if bar > 1 %}{% set bar = 1 %}{% endif %}

                                    <div class="item"
                                    data-name="{{ name }}"
                                    data-score="{{ '%.6f'|format(score) }}"
                                    onclick="openPopupFromEl(this)"
                                    role="button" tabindex="0">
                                        <img class="thumb" src="/static/uploads/{{ name }}" alt="result">
                                        <div class="meta">
                                            <div class="scoreLine">
                                                <b>é¡ä¼¼åº¦ (Similarity)</b>
                                                <span>{{ "%.3f"|format(score) }}</span>
                                            </div>
                                            <div class="bar"><div style="width: {{ (bar*100)|round(0) }}%;"></div></div>

                                                <div class="desc">
                                                    {% if desc %}
                                                        {{ desc }}
                                                    {% else %}
                                                        ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º (Click for details)
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                {% endfor %}
                            </div>

                            {% else %}
                                <div class="empty">
                                    <b>ã¾ã çµæœãŒã‚ã‚Šã¾ã›ã‚“ (No results yet)</b><br>
                                    â‘  åŸºæº–ç”»åƒã‚’é¸ã¶ (Select a reference image) â†’ â‘¡ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸ã¶ (Select a folder) â†’ â‘¢ æ¤œç´¢é–‹å§‹ (Start Search)<br>
                                    ã‚‚ã—0ä»¶ãªã‚‰ã€ã—ãã„å€¤ã‚’å°‘ã—ä¸‹ã’ã¦ã¿ã¦ã­ (If 0 results, try lowering the threshold a bit)
                                </div>
                            {% endif %}

                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- Popup -->
    <div id="popup" onclick="closePopup(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modalHd">
                <b id="popup-title">è©³ç´° (Details)</b>
                <button class="x" type="button" onclick="forceClose()">âœ•</button>
            </div>

            <div class="modalBd">
                <div class="modalImg">
                    <img id="popup-img" alt="popup">
                </div>
                <div class="modalSide">
                    <div class="kv">
                        <b>ã‚¹ã‚³ã‚¢ (score)</b>
                        <span id="popup-score">-</span>
                    </div>

                    <div class="kv">
                        <b>èª¬æ˜ (explain)</b>
                        <span id="popup-text">
                            <span class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> æº–å‚™ä¸­</span>
                        </span>
                    </div>

                    <div class="kv">
                        <b>å†…è¨³ (Breakdown)</b>

                        <span>è‰² (color)</span>
                        <div class="bar"><div id="m-color"></div></div>

                        <span>æ˜ã‚‹ã• (Brightness)</span>
                        <div class="bar"><div id="m-bright"></div></div>

                        <span>æ§‹é€  (Structure)</span>
                        <div class="bar"><div id="m-struct"></div></div>

                        <span>å½¢ï¼ˆORBï¼‰</span>
                        <div class="bar"><div id="m-shape"></div></div>

                        <span id="clip-note" style="font-size:12px; color: var(--muted);">
                            CLIP: æœªå®Ÿè¡Œ
                        </span>

                        <span>CLIP</span>
                        <div class="bar"><div id="m-clip"></div></div>
                    </div>

                    <div class="kv">
                        <b>æ“ä½œ(Operation)</b>
                        <span>èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ or âœ• ã§é–‰ã˜ã¾ã™(Click the background or âœ• to close.)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // Theme
    function applyTheme(theme){
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem("theme", theme);
        document.getElementById("themeLabel").textContent = (theme === "light") ? "Light" : "Dark";
    }
    function toggleTheme(){
        const cur = document.documentElement.getAttribute("data-theme") || "dark";
        applyTheme(cur === "dark" ? "light" : "dark");
    }
    (function initTheme(){
        const saved = localStorage.getItem("theme") || "dark";
        applyTheme(saved);
    })();

    // Threshold sync
    function clamp01(x){
        x = Number(x);
        if (isNaN(x)) return 0.4;
        if (x < 0) return 0;
        if (x > 1) return 1;
        return Math.round(x * 100) / 100;
    }
    function syncThreshold(v, fromNum=false){
        const val = clamp01(v);
        const form = document.getElementById("searchForm");
        const range = form.querySelector('input[type="range"][name="threshold"]');
        const num = document.getElementById("thNum");
        range.value = val;
        num.value = val;
    }
    function bumpThreshold(delta){
        const num = document.getElementById("thNum");
        syncThreshold(clamp01(Number(num.value) + delta), true);
    }
    function setThreshold(v){
        syncThreshold(v, true);
    }

    // -----------------------------
    // Popup helpers
    // -----------------------------

    /**
    * ãƒãƒ¼è¡¨ç¤ºã‚’ 0ã€œ100% ã§åæ˜ ã™ã‚‹
    */
    function setBar(id, v){
        const el = document.getElementById(id);
        if (!el) return;
        const pct = Math.max(0, Math.min(100, Number(v) || 0));
        el.style.width = pct + "%";
    }

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨ã«ã€æ¤œç´¢æ™‚ç‚¹ã®ã‚¹ã‚³ã‚¢ã‚’ä¿æŒ
    let currentScores = null;

    function openPopupFromEl(el){
        const name = el.dataset.name;
        const score = Number(el.dataset.score); // äº’æ›ã§æ®‹ã™

        // â˜…æ¤œç´¢æ™‚ç‚¹ã®ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜ï¼ˆã“ã‚Œã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºã«ä½¿ã†ï¼‰
        currentScores = {
            hist100: Number(el.dataset.hist100 || 0),
            clip: Number(el.dataset.clip || 0),
            final100: Number(el.dataset.final100 || 0),
        };

        openPopup(name, score);
    }


    /**
     * fetchã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ããƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆãƒãƒƒãƒˆãŒé…ã„/ã‚µãƒ¼ãƒãŒé‡ã„æ™‚ã«å›ºã¾ã‚‰ãªã„ï¼‰
     */
    async function fetchJsonWithTimeout(url, options, timeoutMs){
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), timeoutMs);

        try{
            const res = await fetch(url, { ...options, signal: ctrl.signal });

            // HTTPã‚¨ãƒ©ãƒ¼æ™‚ã¯ json() ã›ãšã€text() ã‚’èª­ã‚“ã§åŸå› ã‚’ãƒ­ã‚°ã«æ®‹ã™
            if(!res.ok){
                const t = await res.text().catch(() => "");
                const err = new Error(`HTTP ${res.status} ${res.statusText}`);
                err.status = res.status;
                err.bodyText = t;
                throw err;
            }

            return await res.json();
        } finally {
            clearTimeout(timer);
        }
    }

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§é¸æŠä¸­ã®ç”»åƒ
    let currentBase = null;
    let currentTarget = null;


    // ---- HF CLIP API URL ----
    const HF_CLIP_SIM_URL = "https://taku1103-clip-sim-api.hf.space/clip_sim";

    /**
     * ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§ fetch ã—ã¦ Blob ã‚’è¿”ã™
     */
    async function fetchBlobWithTimeout(url, timeoutMs){
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), timeoutMs);

        try{
            const res = await fetch(url, { method: "GET", cache: "no-store", signal: ctrl.signal });
            if(!res.ok){
                const t = await res.text().catch(() => "");
                const err = new Error(`HTTP ${res.status} ${res.statusText}`);
                err.status = res.status;
                err.bodyText = t;
                throw err;
            }
            return await res.blob();
        } finally {
            clearTimeout(timer);
        }
    }

    /**
     * ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§ multipart POST â†’ JSON ã‚’è¿”ã™
     */
    async function postMultipartJsonWithTimeout(url, formData, timeoutMs){
        const ctrl = new AbortController();
        const timer = setTimeout(() => ctrl.abort(), timeoutMs);

        try{
            const res = await fetch(url, {
                method: "POST",
                body: formData,
                signal: ctrl.signal
                // Content-Type ã¯è‡ªåˆ†ã§ä»˜ã‘ãªã„ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãŒboundaryä»˜ãã§ä»˜ã‘ã‚‹ï¼‰
            });

            if(!res.ok){
                const t = await res.text().catch(() => "");
                const err = new Error(`HTTP ${res.status} ${res.statusText}`);
                err.status = res.status;
                err.bodyText = t;
                throw err;
            }

            return await res.json();
        } finally {
            clearTimeout(timer);
        }
    }

    /**
     * ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æœ¬ä½“ï¼ˆã“ã“ãŒ openPopup()ï¼‰
     *
     * ã„ã¾ã¯ /analyze ãŒé‡ãã¦ 502 ã«ãªã‚Šã‚„ã™ã„ã®ã§ã€
     * - å¤±æ•—æ™‚ã®è¡¨ç¤ºã‚’æ”¹å–„
     * - å›ºã¾ã‚‰ãªã„ã‚ˆã†ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
     */
    async function openPopup(name, score){
        const popup = document.getElementById("popup");
        const img = document.getElementById("popup-img");
        const title = document.getElementById("popup-title");
        const sc = document.getElementById("popup-score");
        const text = document.getElementById("popup-text");

        // Jinjaã§åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹åŸºæº–ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆã‚µãƒ¼ãƒå´ã®baseï¼‰
        const base = "{{ base }}";

        // åŸºæº–ç”»åƒãŒç„¡ã‘ã‚Œã°åˆ†æã§ããªã„
        if (!base){
            sc.textContent = "â€”";
            text.textContent = "(åŸºæº–ç”»åƒãŒé¸ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ã­ğŸ“¸(No reference image has been selected. Please run a search first))";
            popup.style.display = "flex";
            return;
        }

        currentBase = base;
        currentTarget = name;

        // CLIP UIï¼šæ¤œç´¢æ™‚ç‚¹ã®å€¤ã‚’å³åæ˜ ï¼ˆæ­£è§£â‘ ï¼‰
        const clipNote = document.getElementById("clip-note");

        // currentScores ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
        const clipFromSearch = currentScores?.clip ?? 0;
        setBar("m-clip", clipFromSearch);

        if (clipNote) {
            clipNote.textContent = `CLIP: ${clipFromSearch} / 100ï¼ˆæ¤œç´¢æ™‚ã«è¨ˆç®—æ¸ˆã¿ï¼‰`;
        }


        // ã¾ãšã¯ã€Œãã®ç”»åƒã€ã‚’è¡¨ç¤ºï¼ˆã‚ã¨ã§overlayã«å·®ã—æ›¿ãˆã‚‹ï¼‰
        img.src = "/static/uploads/" + name;
        title.textContent = "è©³ç´°: " + name;

        // UIã‚’ã€Œåˆ†æä¸­ã€ã«ã™ã‚‹
        sc.textContent = "åˆ†æä¸­(Analyzing)â€¦";
        // ã¾ãšæ¤œç´¢æ™‚ç‚¹ã®ç·åˆã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤ºï¼ˆCLIPè¾¼ã¿ï¼‰
        if (currentScores && currentScores.final100 !== undefined) {
            sc.textContent = `${currentScores.final100} / 100ï¼ˆæ¤œç´¢æ™‚ã®ç·åˆï¼‰`;
        }

        text.innerHTML = '<span class="loading"><span class="dot"></span><span class="dot"></span><span class="dot"></span> åˆ†æä¸­(Analyzing)â€¦</span>';

        // ãƒãƒ¼ã¯ä¸€æ—¦ã‚¼ãƒ­è¡¨ç¤º
        setBar("m-color", 0);
        setBar("m-bright", 0);
        setBar("m-struct", 0);
        setBar("m-shape", 0);

        popup.style.display = "flex";

        try{
            // ã“ã“ãŒã€Œé‡ã„åˆ†æã€ã€‚ã¾ãšã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å…¥ã‚Œã¦å›ºã¾ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
            // 502ãŒå‡ºã‚‹ãªã‚‰ timeout ã‚’çŸ­ã‚ã«ã—ã¦ã€Œå¤±æ•—ã—ãŸã‚‰è«¦ã‚ã‚‹ã€UXã«ã™ã‚‹ã®ã‚‚ã‚¢ãƒª
            const data = await fetchJsonWithTimeout(
                "/analyze",
                {
                    method: "POST",
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ base: base, target: name })
                },
                25000 // 25ç§’ï¼ˆã¾ãšã¯ã“ã“ã€‚/analyzeã‚’è»½é‡åŒ–ã—ãŸã‚‰çŸ­ãã§ãã‚‹ï¼‰
            );

            // overlayç”»åƒãŒã‚ã‚Œã°å·®ã—æ›¿ãˆ
            if (data.overlay_url){
                img.src = data.overlay_url;
            }

            // èª¬æ˜æ–‡
            text.textContent = data.text || "èª¬æ˜ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚(The description could not be retrieved.)";

            // å†…è¨³ãƒãƒ¼
            if (data.metrics){
                setBar("m-color", data.metrics.color);
                setBar("m-bright", data.metrics.brightness);
                setBar("m-struct", data.metrics.structure);
                setBar("m-shape", data.metrics.shape);
            }

        } catch(e){
            sc.textContent = "â€”";

            if (e && e.status){
                text.textContent =
                    `åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${e.status}ï¼‰ã€‚ã‚µãƒ¼ãƒãŒæ··é›‘/é‡ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n` +
                    `Analysis failed (HTTP ${e.status}). The server may be busy or slow.`;
                console.error("analyze failed:", e.status, e.bodyText || "");
            } else if (e && e.name === "AbortError"){
                text.textContent =
                    "åˆ†æãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆé‡ã„å‡¦ç†ã®ãŸã‚ä¸­æ–­ï¼‰ã€‚\n" +
                    "The analysis timed out (interrupted due to heavy processing).";
                console.error("analyze timeout:", e);
            } else {
                text.textContent =
                    "åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ/analyze ã‚’ç¢ºèªã—ã¦ã­ï¼‰ã€‚\n" +
                    "Analysis failed (check /analyze).";
                console.error("analyze error:", e);
            }
        }
    }

    /**
     * èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
     */
    function closePopup(e){
        if (e.target === e.currentTarget) {
            forceClose();
        }
    }

    function forceClose(){
        document.getElementById("popup").style.display = "none";
        document.getElementById("popup-img").src = "";
        document.getElementById("popup-score").textContent = "-";
        document.getElementById("popup-text").textContent = "";
        setBar("m-color", 0);
        setBar("m-bright", 0);
        setBar("m-struct", 0);
        setBar("m-shape", 0);
        setBar("m-clip", 0);

        const clipNote = document.getElementById("clip-note");
        if (clipNote) clipNote.textContent = "CLIP: æœªè¨ˆç®— (Uncalculated)";
    }

    function showOverlay(show){
        const o = document.getElementById("searchOverlay");
        if(!o) return;
        o.style.display = show ? "flex" : "none";
    }

    function renderResults(baseName, threshold, results){
        // hidden prev_base æ›´æ–°ï¼ˆæ¬¡å›ã‚‚åŸºæº–ç”»åƒç¶­æŒã§ãã‚‹ï¼‰
        const prev = document.querySelector('input[name="prev_base"]');
        if(prev) prev.value = baseName;

        // åŸºæº–ç”»åƒè¡¨ç¤ºã®å·®ã—æ›¿ãˆï¼ˆãƒšãƒ¼ã‚¸å†…ã« baseBox ãŒã‚ã‚‹å‰æï¼‰
        // ã‚‚ã—ãƒ™ãƒ¼ã‚¹è¡¨ç¤ºãŒJSã§ç„¡ã„ãªã‚‰ã€ã“ã“ã¯ç„¡ç†ã«è§¦ã‚‰ãªãã¦OK
        const baseImg = document.querySelector(".baseBox img");
        if(baseImg) baseImg.src = "/static/uploads/" + baseName;

        // resultsArea ã‚’ä½œã£ã¦ä¸Šæ›¸ã
        const area = document.getElementById("resultsArea");
        if(!area) return;

        if(!results || results.length === 0){
            area.innerHTML = `
                <div class="empty">
                    <b>0ä»¶ã§ã—ãŸ</b><br>
                    ã—ãã„å€¤ã‚’ä¸‹ã’ã¦ã¿ã¦ã­ï¼ˆThreshold: ${Number(threshold).toFixed(2)}ï¼‰
                </div>
            `;
            return;
        }

        const cards = results.map(r => {
            const name = r.name;
            const final100 = r.final100 ?? 0;
            // è¡¨ç¤ºç”¨ã®ãƒãƒ¼å¹…
            const bar = Math.max(0, Math.min(100, final100));

            // data-score ã¯ openPopupFromEl ãŒèª­ã‚€ï¼ˆä»Šã¯ä½¿ã£ã¦ãªãã¦ã‚‚OKï¼‰
            return `
                <div class="item"
                    data-name="${name}"
                    data-score="${(r.hist ?? 0)}"
                    data-hist100="${(r.hist100 ?? 0)}"
                    data-clip="${(r.clip ?? 0)}"
                    data-final100="${(r.final100 ?? 0)}"
                    onclick="openPopupFromEl(this)"
                    role="button" tabindex="0">
                    <img class="thumb" src="/static/uploads/${name}" alt="result">
                    <div class="meta">
                        <div class="scoreLine">
                            <b>ç·åˆ (OpenCV+CLIP)</b>
                            <span>${final100} / 100</span>
                        </div>
                        <div class="bar"><div style="width:${bar}%;"></div></div>
                        <div class="desc">
                            OpenCV:${r.hist100 ?? 0} / CLIP:${r.clip ?? 0}
                        </div>
                    </div>
                </div>
            `;
        }).join("");

        area.innerHTML = `<div class="resultsGrid">${cards}</div>`;
    }

    (function hookSearchForm(){
        const form = document.getElementById("searchForm");
        if(!form) return;

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            showOverlay(true);

            try{
                const fd = new FormData(form);
                const res = await fetch("/search_api", { method:"POST", body: fd });
                const data = await res.json().catch(() => null);

                if(!res.ok || !data || !data.ok){
                    const msg = data?.error || `æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${res.status}ï¼‰`;
                    alert(msg);
                    showOverlay(false);
                    return;
                }

                renderResults(data.base, data.threshold, data.results);
                showOverlay(false);

            } catch(err){
                console.error(err);
                alert("æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼‰");
                showOverlay(false);
            }
        });
    })();
</script>

<div id="searchOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:99999; align-items:center; justify-content:center;">
    <div style="padding:16px 18px; border-radius:14px; border:1px solid rgba(255,255,255,.2); background:rgba(10,16,40,.92); color:#fff;">
        ğŸ” æ¤œç´¢ä¸­â€¦ï¼ˆOpenCV â†’ CLIPåæ˜ ï¼‰<br>
        <span style="font-size:12px; opacity:.8;">åˆå›ã¯å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™</span>
    </div>
</div>

</body>
</html>